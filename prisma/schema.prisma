// FumbleBot Database Schema
// @crit-fumble/fumblebot-db package
// PostgreSQL database with Prisma 7 driver adapters

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/fumblebot"
}

datasource db {
  provider = "postgresql"
}

// ===========================================
// Guild & Member Management
// ===========================================

model Guild {
  id          String   @id @default(cuid())
  guildId     String   @unique
  name        String?
  isHome      Boolean  @default(false) // true = FUMBLEBOT_DISCORD_GUILD_ID (admin access)
  settings    Json     @default("{}")
  installedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members          GuildMember[]
  sessions         Session[]
  diceRolls        DiceRoll[]
  commands         BotCommand[]
  promptPartials   PromptPartial[]
  channelKBSources ChannelKBSource[]
}

model GuildMember {
  id        String   @id @default(cuid())
  guildId   String
  discordId String
  username  String
  roles     String[] @default([])
  isAdmin   Boolean  @default(false)
  joinedAt  DateTime @default(now())

  guild Guild @relation(fields: [guildId], references: [guildId], onDelete: Cascade)

  @@unique([guildId, discordId])
  @@index([discordId])
}

// ===========================================
// NOTE: Scripted AI Content models (ScriptedBehavior, DialogueTree,
// RandomTable) have been moved to Core.
// CachedRule is kept locally for ephemeral rule caching.
// ===========================================

model CachedRule {
  id        String   @id @default(cuid())
  query     String
  system    String
  answer    String   @db.Text
  cachedAt  DateTime @default(now())
  expiresAt DateTime

  @@unique([system, query])
  @@index([expiresAt])
}

// ===========================================
// Gaming & Statistics
// ===========================================

model DiceRoll {
  id        String   @id @default(cuid())
  guildId   String
  discordId String
  channelId String?
  notation  String
  rolls     Int[]
  total     Int
  isCrit    Boolean  @default(false)
  isFumble  Boolean  @default(false)
  rolledAt  DateTime @default(now())

  guild Guild @relation(fields: [guildId], references: [guildId], onDelete: Cascade)

  @@index([discordId])
  @@index([guildId, rolledAt])
}

model Session {
  id        String   @id @default(cuid())
  guildId   String
  channelId String?
  name      String
  system    String?
  code      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  guild Guild @relation(fields: [guildId], references: [guildId], onDelete: Cascade)

  @@index([guildId])
}

// ===========================================
// NOTE: Campaign-related models have been moved to Core:
// - FumbleCampaign → Campaign
// - FumbleCharacter → Character
// - FoundryWorldSnapshot → WorldSnapshot
// - FumbleAsset → Asset
// - FoundrySystem → FoundrySystemRecord
// - FumbleSession → GameSession
// - FumbleMessage → SessionMessage
// ===========================================

// ===========================================
// Prompt Partials (Channel/Category/Role AI Customization)
// ===========================================

// Target types for prompt partials
// "channel" - Specific channel (text/voice)
// "category" - All channels in a category
// "thread" - Specific thread
// "role" - Users with this role
enum PromptTargetType {
  channel
  category
  thread
  role
}

model PromptPartial {
  id      String @id @default(cuid())
  guildId String

  // What this prompt applies to
  targetType PromptTargetType
  targetId   String // Discord ID of channel/category/thread/role

  // Human-readable name (cached from Discord for display)
  targetName String?

  // The prompt partial content
  name        String // User-defined name like "Tavern RP Guidelines"
  description String? // Optional description
  content     String  @db.Text // The actual prompt text

  // Priority for when multiple partials apply (higher = more important)
  priority Int @default(0)

  // Enable/disable without deleting
  isEnabled Boolean @default(true)

  // Audit
  createdBy String // Discord ID
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  guild Guild @relation(fields: [guildId], references: [guildId], onDelete: Cascade)

  @@unique([guildId, targetType, targetId, name])
  @@index([guildId, targetType])
  @@index([guildId, isEnabled])
}

// ===========================================
// Channel Knowledge Base Sources
// Discord channels/forums used as knowledge base
// ===========================================

// Channel types for KB sources
enum ChannelKBType {
  text
  forum
  thread
}

model ChannelKBSource {
  id      String @id @default(cuid())
  guildId String

  // Channel info
  channelId   String
  channelName String?
  channelType ChannelKBType @default(text)

  // Configuration
  name        String  // User-friendly name like "House Rules"
  description String? // Optional description
  category    String  @default("general") // KB category for search filtering

  // Sync settings
  syncEnabled Boolean @default(true)
  syncThreads Boolean @default(true)  // For forums: sync all threads
  syncPinned  Boolean @default(true)  // Prioritize pinned messages
  maxMessages Int     @default(100)   // Limit per channel/thread

  // Audit
  createdBy      String // Discord ID
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  lastSyncAt     DateTime?
  lastSyncStatus String?   // 'success' | 'error' | 'partial'
  lastSyncError  String?

  guild Guild @relation(fields: [guildId], references: [guildId], onDelete: Cascade)

  @@unique([guildId, channelId])
  @@index([guildId])
}

// ===========================================
// Analytics
// ===========================================

model BotCommand {
  id         String   @id @default(cuid())
  guildId    String
  discordId  String
  command    String
  subcommand String?
  executedAt DateTime @default(now())

  guild Guild @relation(fields: [guildId], references: [guildId], onDelete: Cascade)

  @@index([command])
  @@index([guildId, executedAt])
}

// ===========================================
// Auth.js / Web Sessions
// ===========================================

model AuthUser {
  id            String   @id @default(cuid())
  discordId     String   @unique
  username      String
  discriminator String?
  avatar        String?
  email         String?  @unique
  globalName    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sessions AuthSession[]
  accounts AuthAccount[]
}

model AuthSession {
  id           String   @id @default(cuid())
  userId       String
  accessToken  String   @db.Text
  refreshToken String?  @db.Text
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model AuthAccount {
  id                String  @id @default(cuid())
  userId            String
  type              String // "oauth"
  provider          String // "discord"
  providerAccountId String // Discord user ID
  access_token      String? @db.Text
  refresh_token     String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?

  user AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

// Express session store table
model ExpressSession {
  sid    String   @id
  sess   Json
  expire DateTime

  @@index([expire])
}

// ===========================================
// User Settings (Discord user preferences)
// Will migrate to Core once user settings API is ready
// ===========================================

model UserSettings {
  id        String   @id @default(cuid())
  discordId String   @unique

  // Voice preferences
  defaultVoice String @default("orion")

  // Game system preferences
  defaultGameSystem String @default("5e")

  // World Anvil integration
  worldAnvilConnected    Boolean @default(false)
  worldAnvilUsername     String?
  worldAnvilDefaultWorld String?
  worldAnvilWorldName    String?

  // Notification preferences
  notifySessionReminders Boolean @default(true)
  notifyTranscriptReady  Boolean @default(true)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
