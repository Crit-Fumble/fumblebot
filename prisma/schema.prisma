// FumbleBot Database Schema
// @crit-fumble/fumblebot-db package
// PostgreSQL database with Prisma 7 driver adapters

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/fumblebot"
}

datasource db {
  provider = "postgresql"
}

// ===========================================
// Guild & Member Management
// ===========================================

model Guild {
  id          String   @id @default(cuid())
  guildId     String   @unique
  name        String?
  isHome      Boolean  @default(false) // true = FUMBLEBOT_DISCORD_GUILD_ID (admin access)
  settings    Json     @default("{}")
  installedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members          GuildMember[]
  sessions         Session[]
  diceRolls        DiceRoll[]
  commands         BotCommand[]
  promptPartials   PromptPartial[]
  channelKBSources ChannelKBSource[]
}

model GuildMember {
  id        String   @id @default(cuid())
  guildId   String
  discordId String
  username  String
  roles     String[] @default([])
  isAdmin   Boolean  @default(false)
  joinedAt  DateTime @default(now())

  guild Guild @relation(fields: [guildId], references: [guildId], onDelete: Cascade)

  @@unique([guildId, discordId])
  @@index([discordId])
}

// ===========================================
// NOTE: Scripted AI Content models (ScriptedBehavior, DialogueTree,
// RandomTable) have been moved to Core.
// CachedRule is kept locally for ephemeral rule caching.
// ===========================================

model CachedRule {
  id        String   @id @default(cuid())
  query     String
  system    String
  answer    String   @db.Text
  cachedAt  DateTime @default(now())
  expiresAt DateTime

  @@unique([system, query])
  @@index([expiresAt])
}

// ===========================================
// Gaming & Statistics
// ===========================================

model DiceRoll {
  id        String   @id @default(cuid())
  guildId   String
  discordId String
  channelId String?
  notation  String
  rolls     Int[]
  total     Int
  isCrit    Boolean  @default(false)
  isFumble  Boolean  @default(false)
  rolledAt  DateTime @default(now())

  guild Guild @relation(fields: [guildId], references: [guildId], onDelete: Cascade)

  @@index([discordId])
  @@index([guildId, rolledAt])
}

model Session {
  id        String   @id @default(cuid())
  guildId   String
  channelId String?
  name      String
  system    String?
  code      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  guild Guild @relation(fields: [guildId], references: [guildId], onDelete: Cascade)

  @@index([guildId])
}

// ===========================================
// NOTE: Campaign-related models have been moved to Core:
// - FumbleCampaign → Campaign
// - FumbleCharacter → Character
// - FoundryWorldSnapshot → WorldSnapshot
// - FumbleAsset → Asset
// - FoundrySystem → FoundrySystemRecord
// - FumbleSession → GameSession
// - FumbleMessage → SessionMessage
// ===========================================

// ===========================================
// Prompt Partials (Channel/Category/Role AI Customization)
// ===========================================

// Target types for prompt partials
// "channel" - Specific channel (text/voice)
// "category" - All channels in a category
// "thread" - Specific thread
// "role" - Users with this role
enum PromptTargetType {
  channel
  category
  thread
  role
}

model PromptPartial {
  id      String @id @default(cuid())
  guildId String

  // What this prompt applies to
  targetType PromptTargetType
  targetId   String // Discord ID of channel/category/thread/role

  // Human-readable name (cached from Discord for display)
  targetName String?

  // The prompt partial content
  name        String // User-defined name like "Tavern RP Guidelines"
  description String? // Optional description
  content     String  @db.Text // The actual prompt text

  // Priority for when multiple partials apply (higher = more important)
  priority Int @default(0)

  // Enable/disable without deleting
  isEnabled Boolean @default(true)

  // Audit
  createdBy String // Discord ID
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  guild Guild @relation(fields: [guildId], references: [guildId], onDelete: Cascade)

  @@unique([guildId, targetType, targetId, name])
  @@index([guildId, targetType])
  @@index([guildId, isEnabled])
}

// ===========================================
// Channel Knowledge Base Sources
// Discord channels/forums used as knowledge base
// ===========================================

// Channel types for KB sources
enum ChannelKBType {
  text
  forum
  thread
}

model ChannelKBSource {
  id      String @id @default(cuid())
  guildId String

  // Channel info
  channelId   String
  channelName String?
  channelType ChannelKBType @default(text)

  // Configuration
  name        String  // User-friendly name like "House Rules"
  description String? // Optional description
  category    String  @default("general") // KB category for search filtering

  // Sync settings
  syncEnabled Boolean @default(true)
  syncThreads Boolean @default(true)  // For forums: sync all threads
  syncPinned  Boolean @default(true)  // Prioritize pinned messages
  maxMessages Int     @default(100)   // Limit per channel/thread

  // Audit
  createdBy      String // Discord ID
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  lastSyncAt     DateTime?
  lastSyncStatus String?   // 'success' | 'error' | 'partial'
  lastSyncError  String?

  guild Guild @relation(fields: [guildId], references: [guildId], onDelete: Cascade)

  @@unique([guildId, channelId])
  @@index([guildId])
}

// ===========================================
// Analytics
// ===========================================

model BotCommand {
  id         String   @id @default(cuid())
  guildId    String
  discordId  String
  command    String
  subcommand String?
  executedAt DateTime @default(now())

  guild Guild @relation(fields: [guildId], references: [guildId], onDelete: Cascade)

  @@index([command])
  @@index([guildId, executedAt])
}

// ===========================================
// Context & Memory System
// Hierarchical Discord structure cache for AI context
// ===========================================

// Cached Discord user - tracks users FumbleBot has interacted with
model DiscordUser {
  id               String   @id @default(cuid())
  discordId        String   @unique
  username         String
  displayName      String?
  avatarUrl        String?

  // Tracking
  firstSeen        DateTime @default(now())
  lastSeen         DateTime @updatedAt
  interactionCount Int      @default(0)

  // Relations
  messages         CachedMessage[]

  @@index([discordId])
  @@map("discord_users")
}

// Cached Discord category - top-level organization
model CachedCategory {
  id           String   @id @default(cuid())
  categoryId   String   @unique // Discord snowflake, or "uncategorized" for null
  guildId      String
  name         String
  position     Int      @default(0)

  // Cache metadata
  lastPolled   DateTime @default(now())

  // Relations
  channels     CachedChannel[]

  @@index([guildId])
  @@map("cached_categories")
}

// Cached Discord channel - text, voice, forum, etc.
model CachedChannel {
  id           String   @id @default(cuid())
  channelId    String   @unique // Discord snowflake
  guildId      String
  categoryId   String?  // null = uncategorized
  parentId     String?  // For threads: parent channel ID

  name         String
  type         String   // text, voice, thread, forum, announcement
  topic        String?  @db.Text
  position     Int      @default(0)

  // Thread-specific
  isThread     Boolean  @default(false)
  threadOwnerId String? // For threads: who created it

  // Cache metadata
  lastPolled   DateTime @default(now())
  messageCount Int      @default(0) // Cached message count

  // Relations
  category     CachedCategory? @relation(fields: [categoryId], references: [categoryId])
  messages     CachedMessage[]

  @@index([guildId])
  @@index([guildId, categoryId])
  @@index([parentId])
  @@map("cached_channels")
}

// Cached Discord message - for context and link reconstruction
model CachedMessage {
  id           String   @id @default(cuid())
  messageId    String   @unique // Discord snowflake
  guildId      String
  channelId    String
  threadId     String?  // If in a thread

  // Author
  authorId     String   // Discord user ID
  author       DiscordUser @relation(fields: [authorId], references: [discordId])

  // Content
  content      String   @db.Text
  attachments  Json     @default("[]") // [{url, filename, contentType, size}]
  embeds       Json     @default("[]") // [{url, title, description, thumbnail}]

  // Reply threading
  replyToId    String?  // messageId of parent message

  // Timestamps
  createdAt    DateTime // Discord message timestamp
  editedAt     DateTime? // If edited
  cachedAt     DateTime @default(now())

  // Context tier (for cache management)
  // hot = actively referenced, warm = recent, cold = archived
  tier         String   @default("warm")

  // AI-generated summary (for cold storage compression)
  summary      String?  @db.Text

  // Relations
  channel      CachedChannel @relation(fields: [channelId], references: [channelId])

  // Link reconstruction: https://discord.com/channels/{guildId}/{channelId}/{messageId}

  @@index([guildId, channelId])
  @@index([authorId])
  @@index([createdAt])
  @@index([tier])
  @@map("cached_messages")
}

// ===========================================
// Auth.js / Web Sessions
// ===========================================

model AuthUser {
  id            String   @id @default(cuid())
  discordId     String   @unique
  username      String
  discriminator String?
  avatar        String?
  email         String?  @unique
  globalName    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sessions AuthSession[]
  accounts AuthAccount[]
}

model AuthSession {
  id           String   @id @default(cuid())
  userId       String
  accessToken  String   @db.Text
  refreshToken String?  @db.Text
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model AuthAccount {
  id                String  @id @default(cuid())
  userId            String
  type              String // "oauth"
  provider          String // "discord"
  providerAccountId String // Discord user ID
  access_token      String? @db.Text
  refresh_token     String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?

  user AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

// Express session store table
model ExpressSession {
  sid    String   @id
  sess   Json
  expire DateTime

  @@index([expire])
}

// ===========================================
// User Settings (Discord user preferences)
// Will migrate to Core once user settings API is ready
// ===========================================

model UserSettings {
  id        String   @id @default(cuid())
  discordId String   @unique

  // Voice preferences
  defaultVoice String @default("orion")

  // Game system preferences
  defaultGameSystem String @default("5e")

  // World Anvil integration
  worldAnvilConnected    Boolean @default(false)
  worldAnvilUsername     String?
  worldAnvilDefaultWorld String?
  worldAnvilWorldName    String?

  // Notification preferences
  notifySessionReminders Boolean @default(true)
  notifyTranscriptReady  Boolean @default(true)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ===========================================
// FumbleBot Character System
// Tracks FumbleBot's personas, skills, and capabilities
// ===========================================

// FumbleBot persona/character - different configurations
model BotPersona {
  id          String   @id @default(cuid())
  name        String   // "FumbleBot", "Dungeon Master", "Tavern Keeper Bob"
  slug        String   @unique // "fumblebot", "dm", "tavern-keeper-bob"
  description String?

  // Voice & presentation
  voice       String   @default("orion") // TTS voice
  avatarUrl   String?
  personality String?  @db.Text // Personality prompt/description

  // Model configuration (stats)
  primaryModel   String @default("claude-sonnet") // Main reasoning model
  lookupModel    String @default("claude-haiku")  // Quick lookup model
  maxTokens      Int    @default(2000)
  temperature    Float  @default(0.7)

  // Ownership
  isGlobal    Boolean  @default(false) // Available to all guilds
  guildId     String?  // If guild-specific
  createdBy   String?  // Discord ID of creator

  // Skills this persona has
  skills      BotSkill[]

  // Channel webhooks for this persona
  webhooks    PersonaWebhook[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([guildId])
  @@index([isGlobal])
}

// Discord webhooks for persona to speak as characters
model PersonaWebhook {
  id          String   @id @default(cuid())
  personaId   String
  guildId     String
  channelId   String

  // Discord webhook details
  webhookId   String
  webhookToken String

  // Cached for display
  channelName String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  persona     BotPersona @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@unique([personaId, channelId])
  @@index([guildId])
}

// Skills/capabilities FumbleBot can learn
model BotSkill {
  id          String   @id @default(cuid())
  name        String   // "Fandom Wiki Search", "World Anvil Integration"
  slug        String   @unique // "fandom-wiki", "world-anvil"
  description String?
  category    String   @default("general") // "knowledge", "tools", "roleplay"

  // Skill mechanics
  toolName    String?  // MCP tool name: "web_search_fandom_wiki"
  isBuiltIn   Boolean  @default(false) // Core capability vs learned

  // Proficiency tracking
  usageCount  Int      @default(0)
  lastUsedAt  DateTime?

  // Which personas have this skill
  personas    BotPersona[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Memory/learning log - what FumbleBot has learned
model BotMemory {
  id          String   @id @default(cuid())

  // Context
  guildId     String?
  channelId   String?
  userId      String?  // Who taught it

  // Memory content
  type        String   // "skill", "fact", "preference", "correction"
  category    String   @default("general")
  key         String   // Lookup key
  content     String   @db.Text // What was learned
  confidence  Float    @default(1.0) // How confident (can decay)

  // Usage tracking
  usageCount  Int      @default(0)
  lastUsedAt  DateTime?

  // Lifecycle
  expiresAt   DateTime? // Optional expiration
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([guildId, type, key])
  @@index([guildId, category])
  @@index([type, key])
}
