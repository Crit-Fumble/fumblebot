// FumbleBot Database Schema
// Independent from main website - runs on separate DigitalOcean PostgreSQL instance

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/fumblebot"
}

datasource db {
  provider = "postgresql"
  url      = env("FUMBLEBOT_DATABASE_URL")
}

// ===========================================
// Guild & Member Management
// ===========================================

model Guild {
  id          String   @id @default(cuid())
  guildId     String   @unique
  name        String?
  isHome      Boolean  @default(false) // true = FUMBLEBOT_DISCORD_GUILD_ID (admin access)
  settings    Json     @default("{}")
  installedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members   GuildMember[]
  sessions  Session[]
  diceRolls DiceRoll[]
  commands  BotCommand[]
  campaigns FumbleCampaign[]
}

model GuildMember {
  id        String   @id @default(cuid())
  guildId   String
  discordId String
  username  String
  roles     String[] @default([])
  isAdmin   Boolean  @default(false)
  joinedAt  DateTime @default(now())

  guild Guild @relation(fields: [guildId], references: [guildId], onDelete: Cascade)

  @@unique([guildId, discordId])
  @@index([discordId])
}

// ===========================================
// Scripted AI Content (cached/pre-generated)
// ===========================================

model ScriptedBehavior {
  id           String   @id @default(cuid())
  creatureType String   @unique
  conditions   Json // BehaviorCondition[]
  generatedAt  DateTime @default(now())
}

model DialogueTree {
  id          String   @id @default(cuid())
  npcId       String   @unique
  npcName     String
  nodes       Json // Serialized Map<string, DialogueNode>
  startNodeId String
  generatedAt DateTime @default(now())
}

model RandomTable {
  id          String   @id @default(cuid())
  tableId     String   @unique
  name        String
  entries     Json // RandomTableEntry[]
  generatedAt DateTime @default(now())
}

model CachedRule {
  id        String   @id @default(cuid())
  query     String
  system    String
  answer    String   @db.Text
  cachedAt  DateTime @default(now())
  expiresAt DateTime

  @@unique([system, query])
  @@index([expiresAt])
}

// ===========================================
// Gaming & Statistics
// ===========================================

model DiceRoll {
  id        String   @id @default(cuid())
  guildId   String
  discordId String
  channelId String?
  notation  String
  rolls     Int[]
  total     Int
  isCrit    Boolean  @default(false)
  isFumble  Boolean  @default(false)
  rolledAt  DateTime @default(now())

  guild Guild @relation(fields: [guildId], references: [guildId], onDelete: Cascade)

  @@index([discordId])
  @@index([guildId, rolledAt])
}

model Session {
  id        String   @id @default(cuid())
  guildId   String
  channelId String?
  name      String
  system    String?
  code      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  guild Guild @relation(fields: [guildId], references: [guildId], onDelete: Cascade)

  @@index([guildId])
}

// ===========================================
// Campaigns (Discord Activity / Foundry)
// ===========================================

model FumbleCampaign {
  id          String   @id @default(cuid())
  guildId     String
  name        String
  description String?  @db.Text

  // Foundry System
  foundrySystemId String?
  foundrySystem   FoundrySystem? @relation(fields: [foundrySystemId], references: [id])

  // Members as JSON: { discordId: { username, role, foundryUserId, joinedAt } }
  members Json @default("{}")

  // Discord role â†’ Foundry role mappings: { discordRoleId: foundryRole }
  roleMappings Json @default("{}")

  // Container Management
  containerId     String?
  containerPort   Int?
  containerStatus String   @default("stopped")
  lastActiveAt    DateTime?

  // Ownership
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  guild      Guild                  @relation(fields: [guildId], references: [guildId], onDelete: Cascade)
  snapshots  FoundryWorldSnapshot[]
  assets     FumbleAsset[]
  characters FumbleCharacter[]
  sessions   FumbleSession[]

  @@unique([guildId, name])
  @@index([guildId])
  @@index([containerStatus])
}

// ===========================================
// Characters (synced from Foundry snapshots)
// ===========================================

model FumbleCharacter {
  id         String @id @default(cuid())
  campaignId String

  // Character identity
  name       String
  type       String // "pc", "npc", "familiar", "companion", "monster"
  avatarUrl  String?

  // Ownership: Discord ID of owner (player, GM, or "fumblebot" for bot-controlled)
  ownerId    String

  // Foundry sync
  foundryActorId String? // Actor ID in Foundry world
  lastSyncedAt   DateTime?

  // Character data (extracted from Foundry actor)
  // Allows FumbleBot to reference stats, abilities, etc. when Foundry is offline
  sheetData Json @default("{}")

  // Status
  isActive  Boolean @default(true) // Currently in play
  isRetired Boolean @default(false) // No longer in campaign

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaign FumbleCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId, foundryActorId])
  @@index([campaignId, type])
  @@index([ownerId])
}

// ===========================================
// World State Persistence
// ===========================================

model FoundryWorldSnapshot {
  id         String  @id @default(cuid())
  campaignId String
  version    Int     @default(1)

  // Metadata
  name   String?
  isAuto Boolean @default(true)

  // Storage reference (DigitalOcean Spaces)
  storageKey String  // "campaigns/{id}/snapshots/{version}.zip"
  sizeBytes  BigInt?

  createdAt DateTime @default(now())
  createdBy String?  // Discord ID of who triggered save (null = auto)

  campaign FumbleCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId, version])
}

// ===========================================
// Asset Storage (DigitalOcean Spaces)
// ===========================================

model FumbleAsset {
  id         String @id @default(cuid())
  campaignId String

  name      String // Original filename
  type      String // "audio", "image", "video", "map", "token"
  mimeType  String
  sizeBytes BigInt

  storageKey String @unique // "campaigns/{id}/assets/{uuid}.ext"
  metadata   Json   @default("{}") // width, height, duration, etc.

  createdAt  DateTime @default(now())
  uploadedBy String   // Discord ID

  campaign FumbleCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId, type])
}

// ===========================================
// Foundry System Registry
// ===========================================

model FoundrySystem {
  id          String   @id @default(cuid())
  systemId    String   @unique // e.g., "dnd5e", "pf2e"
  title       String            // Display name
  description String?  @db.Text
  version     String?
  manifestUrl String   @unique

  // Parsed from manifest
  compatibility Json? // { minimum, verified, maximum }
  authors       Json? // [{ name, url, discord }]

  // FumbleBot settings (merged from FumbleGameSystem)
  iconUrl   String?
  isEnabled Boolean @default(true)
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaigns FumbleCampaign[]
}

// ===========================================
// Game Sessions & Conversation Tracking
// ===========================================

model FumbleSession {
  id         String @id @default(cuid())
  campaignId String

  // Session info
  name        String?  // Optional session name like "Session 12: The Dragon's Lair"
  channelId   String   // Discord channel where session is happening
  voiceChannelId String? // Voice channel if applicable

  // Status
  status    String   @default("active") // "active", "paused", "ended"
  startedAt DateTime @default(now())
  endedAt   DateTime?
  startedBy String   // Discord ID of who started the session

  // Session summary (can be auto-generated or GM-written)
  summary   String?  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaign FumbleCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  messages FumbleMessage[]

  @@index([campaignId, status])
  @@index([channelId])
}

model FumbleMessage {
  id        String @id @default(cuid())
  sessionId String

  // Who said it
  discordId   String  // Discord user ID
  characterId String? // FumbleCharacter ID if speaking as character

  // Message content
  content     String   @db.Text
  messageType String   @default("ic") // "ic" (in-character), "ooc" (out-of-character), "narration", "roll", "system"

  // Discord message reference
  discordMessageId String? @unique

  // Timestamps
  timestamp DateTime @default(now())

  session FumbleSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, timestamp])
  @@index([discordId])
  @@index([characterId])
}

// ===========================================
// Analytics
// ===========================================

model BotCommand {
  id         String   @id @default(cuid())
  guildId    String
  discordId  String
  command    String
  subcommand String?
  executedAt DateTime @default(now())

  guild Guild @relation(fields: [guildId], references: [guildId], onDelete: Cascade)

  @@index([command])
  @@index([guildId, executedAt])
}

// ===========================================
// Auth.js / Web Sessions
// ===========================================

model AuthUser {
  id            String    @id @default(cuid())
  discordId     String    @unique
  username      String
  discriminator String?
  avatar        String?
  email         String?   @unique
  globalName    String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  sessions AuthSession[]
  accounts AuthAccount[]
}

model AuthSession {
  id           String   @id @default(cuid())
  userId       String
  accessToken  String   @db.Text
  refreshToken String?  @db.Text
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model AuthAccount {
  id                String  @id @default(cuid())
  userId            String
  type              String  // "oauth"
  provider          String  // "discord"
  providerAccountId String  // Discord user ID
  access_token      String? @db.Text
  refresh_token     String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?

  user AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

// Express session store table
model ExpressSession {
  sid       String   @id
  sess      Json
  expire    DateTime

  @@index([expire])
}

